<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <title>Medical Report Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
<div class="container">
    <h1>Welcome to the Medical Report Analyzer</h1>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/analysis'">Go to Analysis Page</button>

    <br \>
    <br \>
    <p>Select the conditions you want to analyze from medical reports.</p>
    <!-- Input type selection panel , select input form from txt or pdf-->

    {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

    <form action="{{ url_for('go') }}" enctype="multipart/form-data" method="post">

        <fieldset class="form-control p-3">
            <legend>Input raw reports</legend>
            <div class="row">
                <div class="col">
                    <input class="form-control" accept=".csv,.pdf,.txt" multiple name="files" type="file">
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-secondary" id="merge">Merge to CSV</button>
                </div>
            </div>
        </fieldset>

        <fieldset class="form-control p-3">
            <legend>Input csv or excel for information retrieval</legend>
            <input class="form-control" accept=".csv,.xlsx" name="file" type="file">
        </fieldset>
        <fieldset class="form-control p-3">
            <legend>LLaMA Settings</legend>
            
            <br>

            <div class="mb-3">
                <label class="form-label" for="prompt">Prompt:</label>
                <textarea id="prompt" name="prompt" class="form-control" rows="5">
[INST] &lt;&lt;SYS&gt;&gt;
Sie sind ein medizinischer Assistent von OpenAI ChatGPT. Im Folgenden finden Sie einen Bericht einer neuroradiologischen Intervention. Manchmal sind nicht alle Informationen angegeben. Wenn Informationen fehlen, geben Sie "null" an. Bitte extrahieren Sie die gesuchten Informationen aus dem Interventionsbericht. 
&lt;&lt;/SYS&gt;&gt;
[/INST]
Beispiel: 
Untersuchung vom 22.12.2022.

Indikation: Notfallintervention ohne vorherige schriftliche Einverständniserklärung bei rechtshemisphärieller Schlaganfallsymptomatik mit CT-angiographisch nachgewiesenem prox. M2-Verschluss bei wohl thrombosiertem Aneurysma, ASPECT = 10. Thrombektomie frustran. IV Lyse erfolgt. NihSS: 5. 

Kam es zu einer Blutung? Ja, wenn eine Blutung oder SAB beschrieben wird. Nein, wenn im Befund steht, dass keine Blutung vorliegt. 
ASSISTANT: nein

[INST]
Das ist der Interventionsbericht:
{report}

Kam es zu einer {symptom}? 
[/INST]
                </textarea>
            </div>
            
            <div class="mb-3">
                <label for="variables" class="form-label">Variables (separated by commas):</label>
                <input id="variables" name="variables" type="text" value="Headache,Cancer" class="form-control">
            </div>

            <div class="row">
                <div class="mb-3 col-6">
                    <label for="temperature" class="form-label">Temperature:</label>
                    <input id="temperature" max="1" min="0" name="temperature" step="0.01" type="number" value="0.7" class="form-control">
                </div>
    
                <div class="mb-3 col-6">
                    <label for="model" class="form-label">Model:</label>
                    <select id="model" name="model" class="form-select">
                        <option value="llama-2-7b-chat.Q5_K_M.gguf">LLaMA 2 7b chat</option>
                        <option value="llama-2-70b-chat.Q5_K_M.gguf">LLaMA 2 70b chat</option>
                        <option value="llama-2-13b-chat.Q5_K_M.gguf">LLaMA 2 13b chat</option>
                        <option value="sauerkrautlm-70b-v1.Q5_K_M.gguf">LLaMA 2 70b chat sauerkraut</option>
                        <option value="em_german_70b_v01.Q5_K_M.gguf">LLaMA 2 70b chat emgerman</option>
                    </select>
                </div>
            </div>
        </fieldset>


        <fieldset class="form-control p-3">
            <legend>Postprocessing settings</legend>
            <label for="pattern" class="form-label">Pattern:</label>
            <input name="pattern" type="text" value="ja|nein" class="form-control">
            <label for="default_answer" class="form-label">Default Answer:</label>
            <input name="default_answer" type="text" value="fehlt" class="form-control">
        </fieldset>

        <input class="btn btn-primary" type="submit" value="Go!!!">
    </form>
</div>
<script>
document.getElementById('merge').addEventListener('click', function() {
    var formData = new FormData();
    var input = document.querySelector('input[type="file"]');
    for (var i = 0; i < input.files.length; i++) {
        formData.append('files', input.files[i]);
    }

    fetch('/merge', {
        method: 'POST',
        body: formData
    })
    .then(response => response.blob())
    .then(blob => {
        var url = window.URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'merged.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
    });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</html>
